# Using the Python scripts

**Note: Replace all mentions of `python3` with `py` or `python` if you're on Windows.**

## Requirements

- Python 3.10 or higher
  - Older versions may work, but are not tested
- Requirements listed in `requirements.txt`:
  - Run `python3 -m pip install -r requirements.txt` to install them

## Grabbing data

### Grabbing IPSWs

There are currently two scripts in appledb to grab IPSWs from Apple's servers:

- `grab_ipsws_itunes.py`: This will grab IPSWs from the same link iTunes uses to fetch IPSWs.
- `grab_ipsws_dev_portal.py`: This will grab IPSWs from Apple's developer portal. Since the dev portal requires authentication, you can provide a proxy URL to use to get around this; otherwise, go to the dev portal in your browser, log in if necessary, and save the page to `import_raw.html`.
  - To provide a proxy URL, you have 3 options:
    - Pass it on the command line: `python3 tasks/grab_ipsws_dev_portal.py https://example.com/proxy`
    - Set the environment variable `DEV_PORTAL_PROXY`
    - Or hardcode it in the script

These scripts should be run from the root of the appledb repo:

```bash
cd /path/to/appledb
python3 tasks/grab_ipsws_itunes.py
python3 tasks/grab_ipsws_dev_portal.py <proxy_url>
```

### Grabbing Windows Store apps

Apple publishes some apps for Windows on the Windows Store. `grab_windows_store.py` will use the Windows Store API to get the necessary information to request download links from the Windows Update API.

```bash
python3 tasks/grab_windows_store.py
```

## Importing data

### Importing IPSWs

The `ipsw_import.py` script will import IPSWs from the files generated by the above scripts. You can also import IPSWs manually, one at a time.

**Note:** You can bulk-import IPSWs manually by putting the links in a file named `import.txt`. (Yes, this is the same file that the scripts save to.)

```bash
python3 tasks/ipsw_import.py
```

The script will ask you whether to use bulk mode or not. Press `y` to use bulk mode, or `n` to import IPSWs one at a time.

**Note:** Use Ctrl-C to exit manual import mode.

After bulk import, or after importing each IPSW, the script will automatically run `update_links.py` (see below) to generate all links and update metadata (active, size, hashes, etc). It will also automatically run `sort_os_files.py` (see below) to sort the data.

### Importing OTAs

TODO, but it's mostly the same as `ipsw_import.py`

### Importing Windows Store apps

The `appx_import.py` script will import Windows Store apps from the file generated by `grab_windows_store.py`. There is no option to import manually, as certain information is only available from the API.

```bash
python3 tasks/appx_import.py
```

## Updating links

The `update_links.py` script will update metadata (active, size, hashes, etc). This is automatically run after importing data, but you can also run it manually (ie. if you want to update active status without importing new data).

```bash
python3 tasks/update_links.py
```

## Sorting files

The `sort_os_files.py` script will sort the OS files. This is automatically run after importing data, but you can also run it manually (ie. if you want to sort the data without importing new data).

```bash
python3 tasks/sort_os_files.py
```

## Generating link variants

The `generate_link_variants.py` script will generate alternate links for the OS files. This is run by the CI build, you don't need to run this yourself.

```bash
python3 tasks/generate_link_variants.py
```

## Advanced options

### `update_links.py` `THREAD_COUNT`

`update_links.py` is multithreaded. You can set the number of threads to use by setting the `THREAD_COUNT` variable at the top of the script. The default is 16.

### `ipsw_import.py` `FULL_SELF_DRIVING`

By default, `ipsw_import.py` prompts for certain info that it cannot get from the IPSW, like the friendly version (ie. "15.7.1 RC"). If you want to skip this prompt and fix all the files later, you can set `FULL_SELF_DRIVING` to `True` at the top of the script, which will put in placeholders instead of prompting. Make sure to fix the files later, or else the data will be invalid.
